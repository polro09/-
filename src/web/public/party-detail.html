<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aimdot.dev - íŒŒí‹° ìƒì„¸</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #000000;
            color: #DBDEE1;
            min-height: 100vh;
        }

        /* í—¤ë” */
        .header {
            background-color: #000000;
            border-bottom: 1px solid #1a1a1a;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #F2F3F5;
        }

        .logo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* íŒŒí‹° í—¤ë” */
        .party-header {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .party-title {
            font-size: 32px;
            font-weight: 700;
            color: #F2F3F5;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .party-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 16px;
        }

        .party-status.recruiting {
            background-color: #3BA55C;
            color: #FFFFFF;
        }

        .party-status.in_progress {
            background-color: #FAA61A;
            color: #FFFFFF;
        }

        .party-status.completed {
            background-color: #747F8D;
            color: #FFFFFF;
        }

        .party-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #B5BAC1;
        }

        .info-item i {
            color: #5865F2;
            width: 20px;
        }

        .party-description {
            color: #B5BAC1;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 16px;
            background-color: #000000;
            border-radius: 8px;
        }

        .party-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* íŒ€ ì„¹ì…˜ */
        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .team-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .team-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team1 { color: #0099FF; }
        .team2 { color: #FF0000; }

        .team-count {
            font-size: 14px;
            color: #949BA4;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            background-color: #000000;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .participant-item:hover {
            border-color: #5865F2;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 500;
            color: #F2F3F5;
            margin-bottom: 4px;
        }

        .participant-stats {
            font-size: 12px;
            color: #949BA4;
        }

        .participant-tags {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .country-icon {
            width: 20px;
            height: 20px;
        }

        .unit-tag {
            padding: 2px 8px;
            background-color: #1a1a1a;
            border-radius: 12px;
            font-size: 11px;
            color: #B5BAC1;
        }

        .participant-actions {
            display: flex;
            gap: 8px;
        }

        .move-btn {
            padding: 4px 8px;
            background-color: #1a1a1a;
            color: #B5BAC1;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .move-btn:hover {
            background-color: #2a2a2a;
            color: #F2F3F5;
        }

        /* ëŒ€ê¸°ì ì„¹ì…˜ */
        .waitlist-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .empty-state {
            text-align: center;
            color: #949BA4;
            padding: 40px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #5865F2;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background-color: #4752C4;
        }

        .btn-secondary {
            background-color: #1a1a1a;
            color: #F2F3F5;
        }

        .btn-secondary:hover {
            background-color: #2a2a2a;
        }

        .btn-success {
            background-color: #3BA55C;
            color: #FFFFFF;
        }

        .btn-success:hover {
            background-color: #2D7D46;
        }

        .btn-danger {
            background-color: #ED4245;
            color: #FFFFFF;
        }

        .btn-danger:hover {
            background-color: #C53030;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ì°¸ì—¬ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #F2F3F5;
            margin-bottom: 20px;
        }

        /* êµ­ê°€ ì„ íƒ */
        .country-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .country-btn {
            padding: 12px;
            background-color: #000000;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .country-btn:hover {
            border-color: #5865F2;
        }

        .country-btn.selected {
            background-color: #5865F2;
            border-color: #5865F2;
        }

        .country-btn img {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        .country-name {
            font-size: 12px;
            color: #F2F3F5;
        }

        /* ì „ì  ê¸°ë¡ ì„¹ì…˜ */
        .stats-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stats-player-item {
            background-color: #000000;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            display: grid;
            grid-template-columns: 200px 100px 100px 100px 150px;
            gap: 12px;
            align-items: center;
        }

        .stats-input {
            padding: 6px 12px;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            color: #F2F3F5;
            font-size: 14px;
            text-align: center;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #1a1a1a;
            border-top-color: #5865F2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background-color: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #3BA55C;
        }

        .toast.error {
            border-color: #ED4245;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }

            .party-info {
                grid-template-columns: 1fr;
            }

            .country-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-player-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <img src="https://i.imgur.com/IOPA7gL.gif" alt="Aimdot.dev">
                <h1>Aimdot.dev íŒŒí‹° ì‹œìŠ¤í…œ</h1>
            </a>
            <div class="nav-buttons">
                <a href="/party" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    íŒŒí‹° ëª©ë¡
                </a>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- íŒŒí‹° í—¤ë” -->
        <div class="party-header" id="party-header">
            <div class="party-title">
                <span id="party-emoji"></span>
                <span id="party-title"></span>
                <span class="party-status" id="party-status"></span>
            </div>
            <div class="party-info" id="party-info">
                <!-- íŒŒí‹° ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="party-description" id="party-description">
                <!-- íŒŒí‹° ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="party-actions" id="party-actions">
                <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- íŒ€ ì„¹ì…˜ -->
        <div class="teams-container">
            <div class="team-section">
                <div class="team-header">
                    <h3 class="team-title team1">
                        <i class="fas fa-users"></i>
                        1íŒ€
                    </h3>
                    <span class="team-count" id="team1-count">0/50</span>
                </div>
                <div class="participant-list" id="team1-list">
                    <div class="empty-state">íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <div class="team-section">
                <div class="team-header">
                    <h3 class="team-title team2">
                        <i class="fas fa-users"></i>
                        2íŒ€
                    </h3>
                    <span class="team-count" id="team2-count">0/50</span>
                </div>
                <div class="participant-list" id="team2-list">
                    <div class="empty-state">íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </div>

        <!-- ëŒ€ê¸°ì ì„¹ì…˜ -->
        <div class="waitlist-section">
            <div class="team-header">
                <h3 class="team-title">
                    <i class="fas fa-clock"></i>
                    ëŒ€ê¸°ì
                </h3>
                <span class="team-count" id="waitlist-count">0ëª…</span>
            </div>
            <div class="participant-list" id="waitlist-list">
                <div class="empty-state">ëŒ€ê¸°ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>

        <!-- ì „ì  ê¸°ë¡ ì„¹ì…˜ (Sub Admin ì´ìƒ) -->
        <div class="stats-section" id="stats-section">
            <div class="stats-header">
                <h3 class="team-title">
                    <i class="fas fa-chart-bar"></i>
                    ì „ì  ê¸°ë¡
                </h3>
                <button class="btn btn-primary" onclick="saveStats()">
                    <i class="fas fa-save"></i>
                    ì „ì  ì €ì¥
                </button>
            </div>
            <div class="stats-form" id="stats-form">
                <!-- ì „ì  ì…ë ¥ í¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ì°¸ì—¬ ëª¨ë‹¬ -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <h3 class="modal-header">íŒŒí‹° ì°¸ì—¬</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">êµ­ê°€ ì„ íƒ</label>
                    <div class="country-grid">
                        <div class="country-btn" data-country="empire" onclick="selectCountry('empire')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/sturgia_3_[upscaled].png" alt="ìŠ¤í„°ì§€ì•„">
                            <div class="country-name">ìŠ¤í„°ì§€ì•„</div>
                        </div>
                        <div class="country-btn" data-country="khuzait" onclick="selectCountry('khuzait')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/khuzait_2_[upscaled].png" alt="ì¿ ìì´íŠ¸">
                            <div class="country-name">ì¿ ìì´íŠ¸</div>
                        </div>
                        <div class="country-btn" data-country="aserai" onclick="selectCountry('aserai')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/aserai_2_%7Bupscaled].png" alt="ì•„ì„¸ë¼ì´">
                            <div class="country-name">ì•„ì„¸ë¼ì´</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ë³‘ì¢… ì„ íƒ</label>
                    <select class="form-select" id="unit-select" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="">ë³‘ì¢…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="5t_polearm_infantry">5t í´ì•”ë³´ë³‘</option>
                        <option value="5t_shield_infantry">5t ë°©íŒ¨ë³´ë³‘</option>
                        <option value="5t_archer">5t ê¶ë³‘</option>
                        <option value="5t_crossbow">5t ì„ê¶ë³‘</option>
                        <option value="5t_spearman">5t ì°½ë³‘</option>
                        <option value="5t_horse_archer">5t ê¶ê¸°ë³‘</option>
                        <option value="5t_lancer">5t ì°½ê¸°ë³‘</option>
                        <option value="6t_archer">6t ê¶ë³‘</option>
                        <option value="6t_horse_archer">6t ê¶ê¸°ë³‘</option>
                        <option value="6t_lancer">6t ì°½ê¸°ë³‘</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ì°¸ì—¬ ìœ„ì¹˜</label>
                    <select class="form-select" id="join-position" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="waitlist">ëŒ€ê¸°ì</option>
                        <option value="team1">1íŒ€</option>
                        <option value="team2">2íŒ€</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeJoinModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="joinParty()">ì°¸ì—¬</button>
            </div>
        </div>
    </div>

    <!-- íŒŒí‹° ì¢…ë£Œ ëª¨ë‹¬ -->
    <div class="modal" id="complete-modal">
        <div class="modal-content">
            <h3 class="modal-header">íŒŒí‹° ì¢…ë£Œ</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ê²°ê³¼ ì„ íƒ</label>
                    <select class="form-select" id="party-outcome" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="team1_win">1íŒ€ ìŠ¹ë¦¬</option>
                        <option value="team2_win">2íŒ€ ìŠ¹ë¦¬</option>
                        <option value="draw">ë¬´ìŠ¹ë¶€</option>
                        <option value="completed">ì™„ë£Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ê²°ê³¼ ë©”ì‹œì§€</label>
                    <textarea class="form-textarea" id="result-message" placeholder="ê²°ê³¼ì— ëŒ€í•œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; min-height: 100px; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5; resize: vertical;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeCompleteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="completeParty()">ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div class="toast" id="toast">
        <i class="toast-icon fas fa-check-circle"></i>
        <span class="toast-message" id="toast-message">ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentParty = null;
        let selectedCountry = null;
        let myParticipation = null;

        // êµ­ê°€ ì •ë³´
        const countries = {
            empire: { name: 'ì œêµ­', icon: 'ğŸ›ï¸' },
            vlandia: { name: 'ë¸”ë€ë””ì•„', icon: 'ğŸ¦' },
            battania: { name: 'ë°”íƒ€ë‹ˆì•„', icon: 'ğŸŒ²' },
            sturgia: { name: 'ìŠ¤í„°ì§€ì•„', icon: 'â„ï¸' },
            khuzait: { name: 'ì¿ ìì´íŠ¸', icon: 'ğŸ¹' },
            aserai: { name: 'ì•„ì„¸ë¼ì´', icon: 'ğŸœï¸' }
        };

        // ë³‘ì¢… ì •ë³´
        const units = {
            '5t_polearm_infantry': '5t í´ì•”ë³´ë³‘',
            '5t_shield_infantry': '5t ë°©íŒ¨ë³´ë³‘',
            '5t_archer': '5t ê¶ë³‘',
            '5t_crossbow': '5t ì„ê¶ë³‘',
            '5t_spearman': '5t ì°½ë³‘',
            '5t_horse_archer': '5t ê¶ê¸°ë³‘',
            '5t_lancer': '5t ì°½ê¸°ë³‘',
            '6t_archer': '6t ê¶ë³‘',
            '6t_horse_archer': '6t ê¶ê¸°ë³‘',
            '6t_lancer': '6t ì°½ê¸°ë³‘'
        };

        // íŒŒí‹° íƒ€ì… ì •ë³´
        const partyTypes = {
            ranked: { name: 'ì •ê·œì „', emoji: 'âš”ï¸' },
            practice: { name: 'ëª¨ì˜ì „', emoji: 'ğŸ¯' },
            training: { name: 'í›ˆë ¨', emoji: 'ğŸ“š' },
            pvp: { name: 'PVP', emoji: 'âš¡' },
            blackclaw: { name: 'ê²€ì€ë°œí†±', emoji: 'ğŸ¦…' },
            raid_desert: { name: 'ë ˆì´ë“œ-ì‚¬ë§‰', emoji: 'ğŸœï¸' },
            raid_north: { name: 'ë ˆì´ë“œ-ë¶ë¶€', emoji: 'â„ï¸' }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadPartyDetail();
            
            // 5ì´ˆë§ˆë‹¤ íŒŒí‹° ì •ë³´ ì—…ë°ì´íŠ¸
            setInterval(loadPartyDetail, 5000);
        });

        // ì¸ì¦ í™•ì¸
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    currentUser = await response.json();
                }
            } catch (error) {
                console.error('ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // íŒŒí‹° ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadPartyDetail() {
            const partyId = window.location.pathname.split('/').pop();
            
            try {
                const response = await fetch(`/api/party/${partyId}`);
                if (!response.ok) {
                    throw new Error('íŒŒí‹°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                currentParty = await response.json();
                displayPartyDetail();
                
            } catch (error) {
                console.error('íŒŒí‹° ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('íŒŒí‹°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                setTimeout(() => {
                    window.location.href = '/party';
                }, 2000);
            }
        }

        // íŒŒí‹° ìƒì„¸ ì •ë³´ í‘œì‹œ
        function displayPartyDetail() {
            const party = currentParty;
            const type = partyTypes[party.type];
            
            // íŒŒí‹° ì œëª©
            document.getElementById('party-emoji').textContent = type.emoji;
            document.getElementById('party-title').textContent = party.title;
            
            // íŒŒí‹° ìƒíƒœ
            const statusElement = document.getElementById('party-status');
            statusElement.className = `party-status ${party.status}`;
            statusElement.textContent = {
                recruiting: 'ëª¨ì§‘ ì¤‘',
                in_progress: 'ì§„í–‰ ì¤‘',
                completed: 'ì¢…ë£Œ',
                cancelled: 'ì·¨ì†Œë¨'
            }[party.status];
            
            // íŒŒí‹° ì •ë³´
            const dateStr = new Date(party.scheduledDate).toLocaleDateString('ko-KR');
            document.getElementById('party-info').innerHTML = `
                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <span>${type.name}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-user"></i>
                    <span>${party.hostName}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span>${dateStr}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span>${party.scheduledTime}</span>
                </div>
            `;
            
            // íŒŒí‹° ì„¤ëª…
            if (party.description) {
                document.getElementById('party-description').innerHTML = `
                    <strong>ì„¤ëª…:</strong><br>
                    ${party.description}
                `;
            }
            
            if (party.preparations) {
                document.getElementById('party-description').innerHTML += `
                    <br><br>
                    <strong>ì¤€ë¹„ë¬¼:</strong><br>
                    ${party.preparations}
                `;
            }
            
            // ì°¸ì—¬ í™•ì¸
            checkMyParticipation();
            
            // ì•¡ì…˜ ë²„íŠ¼
            displayActions();
            
            // íŒ€ í‘œì‹œ
            displayTeam('team1', party.team1);
            displayTeam('team2', party.team2);
            displayTeam('waitlist', party.waitlist);
            
            // íŒ€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('team1-count').textContent = `${party.team1.length}/${party.maxTeamSize}`;
            document.getElementById('team2-count').textContent = `${party.team2.length}/${party.maxTeamSize}`;
            document.getElementById('waitlist-count').textContent = `${party.waitlist.length}ëª…`;
            
            // ì „ì  ì„¹ì…˜ í‘œì‹œ (ì¢…ë£Œëœ íŒŒí‹° & Sub Admin ì´ìƒ)
            if (party.status === 'completed' && currentUser && 
                ['subadmin', 'admin', 'owner'].includes(currentUser.dashboardRole)) {
                displayStatsSection();
            }
        }

        // ë‚´ ì°¸ì—¬ í™•ì¸
        function checkMyParticipation() {
            if (!currentUser) {
                myParticipation = null;
                return;
            }
            
            const userId = currentUser.id;
            
            if (currentParty.team1.some(p => p.userId === userId)) {
                myParticipation = { team: 'team1', data: currentParty.team1.find(p => p.userId === userId) };
            } else if (currentParty.team2.some(p => p.userId === userId)) {
                myParticipation = { team: 'team2', data: currentParty.team2.find(p => p.userId === userId) };
            } else if (currentParty.waitlist.some(p => p.userId === userId)) {
                myParticipation = { team: 'waitlist', data: currentParty.waitlist.find(p => p.userId === userId) };
            } else {
                myParticipation = null;
            }
        }

        // ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
        function displayActions() {
            const actionsContainer = document.getElementById('party-actions');
            actionsContainer.innerHTML = '';
            
            if (currentParty.status !== 'recruiting') {
                return;
            }
            
            if (!currentUser) {
                actionsContainer.innerHTML = `
                    <a href="/auth/discord" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        ë¡œê·¸ì¸í•˜ì—¬ ì°¸ì—¬
                    </a>
                `;
                return;
            }
            
            if (!myParticipation) {
                // ì°¸ì—¬í•˜ì§€ ì•Šì€ ê²½ìš°
                actionsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="openJoinModal()">
                        <i class="fas fa-plus"></i>
                        íŒŒí‹° ì°¸ì—¬
                    </button>
                `;
            } else {
                // ì´ë¯¸ ì°¸ì—¬í•œ ê²½ìš°
                actionsContainer.innerHTML = `
                    <button class="btn btn-danger" onclick="leaveParty()">
                        <i class="fas fa-sign-out-alt"></i>
                        íŒŒí‹° íƒˆí‡´
                    </button>
                `;
            }
            
            // ê°œìµœìì¸ ê²½ìš°
            if (currentUser.id === currentParty.hostId) {
                actionsContainer.innerHTML += `
                    <button class="btn btn-secondary" onclick="editParty()">
                        <i class="fas fa-edit"></i>
                        íŒŒí‹° ìˆ˜ì •
                    </button>
                    <button class="btn btn-success" onclick="openCompleteModal()">
                        <i class="fas fa-check"></i>
                        íŒŒí‹° ì¢…ë£Œ
                    </button>
                    <button class="btn btn-danger" onclick="cancelParty()">
                        <i class="fas fa-times"></i>
                        íŒŒí‹° ì·¨ì†Œ
                    </button>
                `;
            }
        }

        // íŒ€ í‘œì‹œ
        function displayTeam(teamName, participants) {
            const container = document.getElementById(`${teamName}-list`);
            container.innerHTML = '';
            
            if (participants.length === 0) {
                container.innerHTML = '<div class="empty-state">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            participants.forEach(participant => {
                const item = createParticipantItem(participant, teamName);
                container.appendChild(item);
            });
        }

        // ì°¸ì—¬ì ì•„ì´í…œ ìƒì„±
        function createParticipantItem(participant, currentTeam) {
            const div = document.createElement('div');
            div.className = 'participant-item';
            
            const avatar = participant.avatar 
                ? `https://cdn.discordapp.com/avatars/${participant.userId}/${participant.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
            
            const countryInfo = participant.country ? countries[participant.country] : null;
            const unitName = participant.unit ? units[participant.unit] : null;
            
            let actionsHtml = '';
            if (currentUser && participant.userId === currentUser.id && currentParty.status === 'recruiting') {
                // ë³¸ì¸ì¸ ê²½ìš° ì´ë™ ë²„íŠ¼
                if (currentTeam !== 'team1') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'team1')">1íŒ€ìœ¼ë¡œ</button>`;
                }
                if (currentTeam !== 'team2') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'team2')">2íŒ€ìœ¼ë¡œ</button>`;
                }
                if (currentTeam !== 'waitlist') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'waitlist')">ëŒ€ê¸°ë¡œ</button>`;
                }
            }
            
            div.innerHTML = `
                <img src="${avatar}" alt="${participant.username}" class="participant-avatar">
                <div class="participant-info">
                    <div class="participant-name">${participant.nickname || participant.username}</div>
                    <div class="participant-stats">
                        ìŠ¹ë¥ : ${participant.stats.winRate}% | í‰ê· í‚¬: ${participant.stats.avgKills}
                    </div>
                </div>
                <div class="participant-tags">
                    ${countryInfo ? `<span title="${countryInfo.name}">${countryInfo.icon}</span>` : ''}
                    ${unitName ? `<span class="unit-tag">${unitName}</span>` : ''}
                </div>
                <div class="participant-actions">
                    ${actionsHtml}
                </div>
            `;
            
            return div;
        }

        // êµ­ê°€ ì„ íƒ
        function selectCountry(country) {
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`[data-country="${country}"]`).classList.add('selected');
            selectedCountry = country;
        }

        // ì°¸ì—¬ ëª¨ë‹¬ ì—´ê¸°
        function openJoinModal() {
            document.getElementById('join-modal').style.display = 'flex';
        }

        // ì°¸ì—¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeJoinModal() {
            document.getElementById('join-modal').style.display = 'none';
            selectedCountry = null;
        }

        // íŒŒí‹° ì°¸ì—¬
        async function joinParty() {
            const country = selectedCountry;
            const unit = document.getElementById('unit-select').value;
            const position = document.getElementById('join-position').value;
            
            if (!country || !unit) {
                showToast('êµ­ê°€ì™€ ë³‘ì¢…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'join',
                        to: position,
                        country,
                        unit
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'íŒŒí‹° ì°¸ì—¬ ì‹¤íŒ¨');
                }
                
                showToast('íŒŒí‹°ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!', 'success');
                closeJoinModal();
                await loadPartyDetail();
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ì°¸ì—¬ì ì´ë™
        async function moveParticipant(from, to) {
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'move',
                        from,
                        to
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ì´ë™ ì‹¤íŒ¨');
                }
                
                showToast('ìœ„ì¹˜ë¥¼ ì´ë™í–ˆìŠµë‹ˆë‹¤!', 'success');
                await loadPartyDetail();
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // íŒŒí‹° íƒˆí‡´
        async function leaveParty() {
            if (!confirm('ì •ë§ë¡œ íŒŒí‹°ì—ì„œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'move',
                        from: myParticipation.team,
                        to: 'remove'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('íƒˆí‡´ ì‹¤íŒ¨');
                }
                
                showToast('íŒŒí‹°ì—ì„œ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.', 'success');
                await loadPartyDetail();
                
            } catch (error) {
                showToast('íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // íŒŒí‹° ì¢…ë£Œ ëª¨ë‹¬ ì—´ê¸°
        function openCompleteModal() {
            document.getElementById('complete-modal').style.display = 'flex';
        }

        // íŒŒí‹° ì¢…ë£Œ ëª¨ë‹¬ ë‹«ê¸°
        function closeCompleteModal() {
            document.getElementById('complete-modal').style.display = 'none';
        }

        // íŒŒí‹° ì¢…ë£Œ
        async function completeParty() {
            const outcome = document.getElementById('party-outcome').value;
            const resultMessage = document.getElementById('result-message').value;
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'complete',
                        outcome,
                        resultMessage
                    })
                });
                
                if (!response.ok) {
                    throw new Error('íŒŒí‹° ì¢…ë£Œ ì‹¤íŒ¨');
                }
                
                showToast('íŒŒí‹°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                closeCompleteModal();
                await loadPartyDetail();
                
            } catch (error) {
                showToast('íŒŒí‹° ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // íŒŒí‹° ì·¨ì†Œ
        async function cancelParty() {
            if (!confirm('ì •ë§ë¡œ íŒŒí‹°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'cancel'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('íŒŒí‹° ì·¨ì†Œ ì‹¤íŒ¨');
                }
                
                showToast('íŒŒí‹°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                setTimeout(() => {
                    window.location.href = '/party';
                }, 1500);
                
            } catch (error) {
                showToast('íŒŒí‹° ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // íŒŒí‹° ìˆ˜ì •
        function editParty() {
            // TODO: íŒŒí‹° ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„
            showToast('íŒŒí‹° ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
        }

        // ì „ì  ì„¹ì…˜ í‘œì‹œ
        function displayStatsSection() {
            document.getElementById('stats-section').style.display = 'block';
            
            const statsForm = document.getElementById('stats-form');
            statsForm.innerHTML = '';
            
            // ëª¨ë“  ì°¸ì—¬ì ëª©ë¡
            const allParticipants = [...currentParty.team1, ...currentParty.team2];
            
            allParticipants.forEach(participant => {
                const statsItem = document.createElement('div');
                statsItem.className = 'stats-player-item';
                
                const team = currentParty.team1.some(p => p.userId === participant.userId) ? 1 : 2;
                const existingStat = currentParty.playerStats?.find(s => s.userId === participant.userId);
                
                statsItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${participant.avatar ? `https://cdn.discordapp.com/avatars/${participant.userId}/${participant.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'}" style="width: 24px; height: 24px; border-radius: 50%;">
                        <span>${participant.nickname || participant.username}</span>
                    </div>
                    <div>
                        <select class="stats-input" data-user="${participant.userId}" data-field="team">
                            <option value="1" ${team === 1 ? 'selected' : ''}>1íŒ€</option>
                            <option value="2" ${team === 2 ? 'selected' : ''}>2íŒ€</option>
                        </select>
                    </div>
                    <input type="number" class="stats-input" data-user="${participant.userId}" data-field="kills" 
                           value="${existingStat?.kills || 0}" min="0" placeholder="í‚¬">
                    <input type="number" class="stats-input" data-user="${participant.userId}" data-field="deaths" 
                           value="${existingStat?.deaths || 0}" min="0" placeholder="ë°ìŠ¤">
                    <div>
                        <select class="stats-input" data-user="${participant.userId}" data-field="won">
                            <option value="true" ${existingStat?.won ? 'selected' : ''}>ìŠ¹ë¦¬</option>
                            <option value="false" ${!existingStat?.won ? 'selected' : ''}>íŒ¨ë°°</option>
                        </select>
                    </div>
                `;
                
                statsForm.appendChild(statsItem);
            });
        }

        // ì „ì  ì €ì¥
        async function saveStats() {
            const statsInputs = document.querySelectorAll('.stats-input');
            const playerStats = {};
            
            statsInputs.forEach(input => {
                const userId = input.dataset.user;
                const field = input.dataset.field;
                
                if (!playerStats[userId]) {
                    playerStats[userId] = { userId };
                }
                
                if (field === 'team' || field === 'kills' || field === 'deaths') {
                    playerStats[userId][field] = parseInt(input.value);
                } else if (field === 'won') {
                    playerStats[userId][field] = input.value === 'true';
                }
            });
            
            const statsArray = Object.values(playerStats);
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/stats`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ playerStats: statsArray })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ì „ì  ì €ì¥ ì‹¤íŒ¨');
                }
                
                showToast('ì „ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = toast.querySelector('.toast-icon');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toastIcon.className = 'toast-icon fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'toast-icon fas fa-exclamation-circle';
            } else {
                toastIcon.className = 'toast-icon fas fa-info-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>ord/emblem_[remade+upscaled].png" alt="ì œêµ­">
                            <div class="country-name">ì œêµ­</div>
                        </div>
                        <div class="country-btn" data-country="vlandia" onclick="selectCountry('vlandia')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/emblem_v_[upscaled].png" alt="ë¸”ë€ë””ì•„">
                            <div class="country-name">ë¸”ë€ë””ì•„</div>
                        </div>
                        <div class="country-btn" data-country="battania" onclick="selectCountry('battania')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/emblem_[upscaled].png" alt="ë°”íƒ€ë‹ˆì•„">
                            <div class="country-name">ë°”íƒ€ë‹ˆì•„</div>
                        </div>
                        <div class="country-btn" data-country="sturgia" onclick="selectCountry('sturgia')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerl