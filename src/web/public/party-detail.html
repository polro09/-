<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aimdot.dev - 파티 상세</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #000000;
            color: #DBDEE1;
            min-height: 100vh;
        }

        /* 헤더 */
        .header {
            background-color: #000000;
            border-bottom: 1px solid #1a1a1a;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #F2F3F5;
        }

        .logo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        /* 메인 컨테이너 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 파티 헤더 */
        .party-header {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .party-title {
            font-size: 32px;
            font-weight: 700;
            color: #F2F3F5;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .party-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 16px;
        }

        .party-status.recruiting {
            background-color: #3BA55C;
            color: #FFFFFF;
        }

        .party-status.in_progress {
            background-color: #FAA61A;
            color: #FFFFFF;
        }

        .party-status.completed {
            background-color: #747F8D;
            color: #FFFFFF;
        }

        .party-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #B5BAC1;
        }

        .info-item i {
            color: #5865F2;
            width: 20px;
        }

        .party-description {
            color: #B5BAC1;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 16px;
            background-color: #000000;
            border-radius: 8px;
        }

        .party-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* 팀 섹션 */
        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .team-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .team-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team1 { color: #0099FF; }
        .team2 { color: #FF0000; }

        .team-count {
            font-size: 14px;
            color: #949BA4;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            background-color: #000000;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .participant-item:hover {
            border-color: #5865F2;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-size: 14px;
            font-weight: 500;
            color: #F2F3F5;
            margin-bottom: 4px;
        }

        .participant-stats {
            font-size: 12px;
            color: #949BA4;
        }

        .participant-tags {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .country-icon {
            width: 20px;
            height: 20px;
        }

        .unit-tag {
            padding: 2px 8px;
            background-color: #1a1a1a;
            border-radius: 12px;
            font-size: 11px;
            color: #B5BAC1;
        }

        .participant-actions {
            display: flex;
            gap: 8px;
        }

        .move-btn {
            padding: 4px 8px;
            background-color: #1a1a1a;
            color: #B5BAC1;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .move-btn:hover {
            background-color: #2a2a2a;
            color: #F2F3F5;
        }

        /* 대기자 섹션 */
        .waitlist-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .empty-state {
            text-align: center;
            color: #949BA4;
            padding: 40px;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #5865F2;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background-color: #4752C4;
        }

        .btn-secondary {
            background-color: #1a1a1a;
            color: #F2F3F5;
        }

        .btn-secondary:hover {
            background-color: #2a2a2a;
        }

        .btn-success {
            background-color: #3BA55C;
            color: #FFFFFF;
        }

        .btn-success:hover {
            background-color: #2D7D46;
        }

        .btn-danger {
            background-color: #ED4245;
            color: #FFFFFF;
        }

        .btn-danger:hover {
            background-color: #C53030;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 참여 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #F2F3F5;
            margin-bottom: 20px;
        }

        /* 국가 선택 */
        .country-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .country-btn {
            padding: 12px;
            background-color: #000000;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .country-btn:hover {
            border-color: #5865F2;
        }

        .country-btn.selected {
            background-color: #5865F2;
            border-color: #5865F2;
        }

        .country-btn img {
            width: 40px;
            height: 40px;
            margin-bottom: 4px;
        }

        .country-name {
            font-size: 12px;
            color: #F2F3F5;
        }

        /* 전적 기록 섹션 */
        .stats-section {
            background-color: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stats-player-item {
            background-color: #000000;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            display: grid;
            grid-template-columns: 200px 100px 100px 100px 150px;
            gap: 12px;
            align-items: center;
        }

        .stats-input {
            padding: 6px 12px;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            color: #F2F3F5;
            font-size: 14px;
            text-align: center;
        }

        /* 로딩 스피너 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #1a1a1a;
            border-top-color: #5865F2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 토스트 알림 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background-color: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #3BA55C;
        }

        .toast.error {
            border-color: #ED4245;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }

            .party-info {
                grid-template-columns: 1fr;
            }

            .country-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-player-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <img src="https://i.imgur.com/IOPA7gL.gif" alt="Aimdot.dev">
                <h1>Aimdot.dev 파티 시스템</h1>
            </a>
            <div class="nav-buttons">
                <a href="/party" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    파티 목록
                </a>
            </div>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <div class="container">
        <!-- 파티 헤더 -->
        <div class="party-header" id="party-header">
            <div class="party-title">
                <span id="party-emoji"></span>
                <span id="party-title"></span>
                <span class="party-status" id="party-status"></span>
            </div>
            <div class="party-info" id="party-info">
                <!-- 파티 정보가 여기에 표시됩니다 -->
            </div>
            <div class="party-description" id="party-description">
                <!-- 파티 설명이 여기에 표시됩니다 -->
            </div>
            <div class="party-actions" id="party-actions">
                <!-- 액션 버튼들이 여기에 표시됩니다 -->
            </div>
        </div>

        <!-- 팀 섹션 -->
        <div class="teams-container">
            <div class="team-section">
                <div class="team-header">
                    <h3 class="team-title team1">
                        <i class="fas fa-users"></i>
                        1팀
                    </h3>
                    <span class="team-count" id="team1-count">0/50</span>
                </div>
                <div class="participant-list" id="team1-list">
                    <div class="empty-state">팀원이 없습니다</div>
                </div>
            </div>

            <div class="team-section">
                <div class="team-header">
                    <h3 class="team-title team2">
                        <i class="fas fa-users"></i>
                        2팀
                    </h3>
                    <span class="team-count" id="team2-count">0/50</span>
                </div>
                <div class="participant-list" id="team2-list">
                    <div class="empty-state">팀원이 없습니다</div>
                </div>
            </div>
        </div>

        <!-- 대기자 섹션 -->
        <div class="waitlist-section">
            <div class="team-header">
                <h3 class="team-title">
                    <i class="fas fa-clock"></i>
                    대기자
                </h3>
                <span class="team-count" id="waitlist-count">0명</span>
            </div>
            <div class="participant-list" id="waitlist-list">
                <div class="empty-state">대기자가 없습니다</div>
            </div>
        </div>

        <!-- 전적 기록 섹션 (Sub Admin 이상) -->
        <div class="stats-section" id="stats-section">
            <div class="stats-header">
                <h3 class="team-title">
                    <i class="fas fa-chart-bar"></i>
                    전적 기록
                </h3>
                <button class="btn btn-primary" onclick="saveStats()">
                    <i class="fas fa-save"></i>
                    전적 저장
                </button>
            </div>
            <div class="stats-form" id="stats-form">
                <!-- 전적 입력 폼이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 참여 모달 -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <h3 class="modal-header">파티 참여</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">국가 선택</label>
                    <div class="country-grid">
                        <div class="country-btn" data-country="empire" onclick="selectCountry('empire')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/sturgia_3_[upscaled].png" alt="스터지아">
                            <div class="country-name">스터지아</div>
                        </div>
                        <div class="country-btn" data-country="khuzait" onclick="selectCountry('khuzait')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/khuzait_2_[upscaled].png" alt="쿠자이트">
                            <div class="country-name">쿠자이트</div>
                        </div>
                        <div class="country-btn" data-country="aserai" onclick="selectCountry('aserai')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/aserai_2_%7Bupscaled].png" alt="아세라이">
                            <div class="country-name">아세라이</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">병종 선택</label>
                    <select class="form-select" id="unit-select" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="">병종을 선택하세요</option>
                        <option value="5t_polearm_infantry">5t 폴암보병</option>
                        <option value="5t_shield_infantry">5t 방패보병</option>
                        <option value="5t_archer">5t 궁병</option>
                        <option value="5t_crossbow">5t 석궁병</option>
                        <option value="5t_spearman">5t 창병</option>
                        <option value="5t_horse_archer">5t 궁기병</option>
                        <option value="5t_lancer">5t 창기병</option>
                        <option value="6t_archer">6t 궁병</option>
                        <option value="6t_horse_archer">6t 궁기병</option>
                        <option value="6t_lancer">6t 창기병</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">참여 위치</label>
                    <select class="form-select" id="join-position" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="waitlist">대기자</option>
                        <option value="team1">1팀</option>
                        <option value="team2">2팀</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeJoinModal()">취소</button>
                <button class="btn btn-primary" onclick="joinParty()">참여</button>
            </div>
        </div>
    </div>

    <!-- 파티 종료 모달 -->
    <div class="modal" id="complete-modal">
        <div class="modal-content">
            <h3 class="modal-header">파티 종료</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">결과 선택</label>
                    <select class="form-select" id="party-outcome" style="width: 100%; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5;">
                        <option value="team1_win">1팀 승리</option>
                        <option value="team2_win">2팀 승리</option>
                        <option value="draw">무승부</option>
                        <option value="completed">완료</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">결과 메시지</label>
                    <textarea class="form-textarea" id="result-message" placeholder="결과에 대한 메시지를 입력하세요" style="width: 100%; min-height: 100px; padding: 10px; background-color: #000000; border: 1px solid #2a2a2a; border-radius: 6px; color: #F2F3F5; resize: vertical;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="closeCompleteModal()">취소</button>
                <button class="btn btn-success" onclick="completeParty()">종료</button>
            </div>
        </div>
    </div>

    <!-- 토스트 알림 -->
    <div class="toast" id="toast">
        <i class="toast-icon fas fa-check-circle"></i>
        <span class="toast-message" id="toast-message">작업이 완료되었습니다.</span>
    </div>

    <script>
        // 전역 변수
        let currentUser = null;
        let currentParty = null;
        let selectedCountry = null;
        let myParticipation = null;

        // 국가 정보
        const countries = {
            empire: { name: '제국', icon: '🏛️' },
            vlandia: { name: '블란디아', icon: '🦁' },
            battania: { name: '바타니아', icon: '🌲' },
            sturgia: { name: '스터지아', icon: '❄️' },
            khuzait: { name: '쿠자이트', icon: '🏹' },
            aserai: { name: '아세라이', icon: '🏜️' }
        };

        // 병종 정보
        const units = {
            '5t_polearm_infantry': '5t 폴암보병',
            '5t_shield_infantry': '5t 방패보병',
            '5t_archer': '5t 궁병',
            '5t_crossbow': '5t 석궁병',
            '5t_spearman': '5t 창병',
            '5t_horse_archer': '5t 궁기병',
            '5t_lancer': '5t 창기병',
            '6t_archer': '6t 궁병',
            '6t_horse_archer': '6t 궁기병',
            '6t_lancer': '6t 창기병'
        };

        // 파티 타입 정보
        const partyTypes = {
            ranked: { name: '정규전', emoji: '⚔️' },
            practice: { name: '모의전', emoji: '🎯' },
            training: { name: '훈련', emoji: '📚' },
            pvp: { name: 'PVP', emoji: '⚡' },
            blackclaw: { name: '검은발톱', emoji: '🦅' },
            raid_desert: { name: '레이드-사막', emoji: '🏜️' },
            raid_north: { name: '레이드-북부', emoji: '❄️' }
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadPartyDetail();
            
            // 5초마다 파티 정보 업데이트
            setInterval(loadPartyDetail, 5000);
        });

        // 인증 확인
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    currentUser = await response.json();
                }
            } catch (error) {
                console.error('인증 확인 오류:', error);
            }
        }

        // 파티 상세 정보 로드
        async function loadPartyDetail() {
            const partyId = window.location.pathname.split('/').pop();
            
            try {
                const response = await fetch(`/api/party/${partyId}`);
                if (!response.ok) {
                    throw new Error('파티를 찾을 수 없습니다');
                }
                
                currentParty = await response.json();
                displayPartyDetail();
                
            } catch (error) {
                console.error('파티 로드 오류:', error);
                showToast('파티를 불러올 수 없습니다.', 'error');
                setTimeout(() => {
                    window.location.href = '/party';
                }, 2000);
            }
        }

        // 파티 상세 정보 표시
        function displayPartyDetail() {
            const party = currentParty;
            const type = partyTypes[party.type];
            
            // 파티 제목
            document.getElementById('party-emoji').textContent = type.emoji;
            document.getElementById('party-title').textContent = party.title;
            
            // 파티 상태
            const statusElement = document.getElementById('party-status');
            statusElement.className = `party-status ${party.status}`;
            statusElement.textContent = {
                recruiting: '모집 중',
                in_progress: '진행 중',
                completed: '종료',
                cancelled: '취소됨'
            }[party.status];
            
            // 파티 정보
            const dateStr = new Date(party.scheduledDate).toLocaleDateString('ko-KR');
            document.getElementById('party-info').innerHTML = `
                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <span>${type.name}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-user"></i>
                    <span>${party.hostName}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <span>${dateStr}</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span>${party.scheduledTime}</span>
                </div>
            `;
            
            // 파티 설명
            if (party.description) {
                document.getElementById('party-description').innerHTML = `
                    <strong>설명:</strong><br>
                    ${party.description}
                `;
            }
            
            if (party.preparations) {
                document.getElementById('party-description').innerHTML += `
                    <br><br>
                    <strong>준비물:</strong><br>
                    ${party.preparations}
                `;
            }
            
            // 참여 확인
            checkMyParticipation();
            
            // 액션 버튼
            displayActions();
            
            // 팀 표시
            displayTeam('team1', party.team1);
            displayTeam('team2', party.team2);
            displayTeam('waitlist', party.waitlist);
            
            // 팀 카운트 업데이트
            document.getElementById('team1-count').textContent = `${party.team1.length}/${party.maxTeamSize}`;
            document.getElementById('team2-count').textContent = `${party.team2.length}/${party.maxTeamSize}`;
            document.getElementById('waitlist-count').textContent = `${party.waitlist.length}명`;
            
            // 전적 섹션 표시 (종료된 파티 & Sub Admin 이상)
            if (party.status === 'completed' && currentUser && 
                ['subadmin', 'admin', 'owner'].includes(currentUser.dashboardRole)) {
                displayStatsSection();
            }
        }

        // 내 참여 확인
        function checkMyParticipation() {
            if (!currentUser) {
                myParticipation = null;
                return;
            }
            
            const userId = currentUser.id;
            
            if (currentParty.team1.some(p => p.userId === userId)) {
                myParticipation = { team: 'team1', data: currentParty.team1.find(p => p.userId === userId) };
            } else if (currentParty.team2.some(p => p.userId === userId)) {
                myParticipation = { team: 'team2', data: currentParty.team2.find(p => p.userId === userId) };
            } else if (currentParty.waitlist.some(p => p.userId === userId)) {
                myParticipation = { team: 'waitlist', data: currentParty.waitlist.find(p => p.userId === userId) };
            } else {
                myParticipation = null;
            }
        }

        // 액션 버튼 표시
        function displayActions() {
            const actionsContainer = document.getElementById('party-actions');
            actionsContainer.innerHTML = '';
            
            if (currentParty.status !== 'recruiting') {
                return;
            }
            
            if (!currentUser) {
                actionsContainer.innerHTML = `
                    <a href="/auth/discord" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        로그인하여 참여
                    </a>
                `;
                return;
            }
            
            if (!myParticipation) {
                // 참여하지 않은 경우
                actionsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="openJoinModal()">
                        <i class="fas fa-plus"></i>
                        파티 참여
                    </button>
                `;
            } else {
                // 이미 참여한 경우
                actionsContainer.innerHTML = `
                    <button class="btn btn-danger" onclick="leaveParty()">
                        <i class="fas fa-sign-out-alt"></i>
                        파티 탈퇴
                    </button>
                `;
            }
            
            // 개최자인 경우
            if (currentUser.id === currentParty.hostId) {
                actionsContainer.innerHTML += `
                    <button class="btn btn-secondary" onclick="editParty()">
                        <i class="fas fa-edit"></i>
                        파티 수정
                    </button>
                    <button class="btn btn-success" onclick="openCompleteModal()">
                        <i class="fas fa-check"></i>
                        파티 종료
                    </button>
                    <button class="btn btn-danger" onclick="cancelParty()">
                        <i class="fas fa-times"></i>
                        파티 취소
                    </button>
                `;
            }
        }

        // 팀 표시
        function displayTeam(teamName, participants) {
            const container = document.getElementById(`${teamName}-list`);
            container.innerHTML = '';
            
            if (participants.length === 0) {
                container.innerHTML = '<div class="empty-state">참여자가 없습니다</div>';
                return;
            }
            
            participants.forEach(participant => {
                const item = createParticipantItem(participant, teamName);
                container.appendChild(item);
            });
        }

        // 참여자 아이템 생성
        function createParticipantItem(participant, currentTeam) {
            const div = document.createElement('div');
            div.className = 'participant-item';
            
            const avatar = participant.avatar 
                ? `https://cdn.discordapp.com/avatars/${participant.userId}/${participant.avatar}.png`
                : 'https://cdn.discordapp.com/embed/avatars/0.png';
            
            const countryInfo = participant.country ? countries[participant.country] : null;
            const unitName = participant.unit ? units[participant.unit] : null;
            
            let actionsHtml = '';
            if (currentUser && participant.userId === currentUser.id && currentParty.status === 'recruiting') {
                // 본인인 경우 이동 버튼
                if (currentTeam !== 'team1') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'team1')">1팀으로</button>`;
                }
                if (currentTeam !== 'team2') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'team2')">2팀으로</button>`;
                }
                if (currentTeam !== 'waitlist') {
                    actionsHtml += `<button class="move-btn" onclick="moveParticipant('${currentTeam}', 'waitlist')">대기로</button>`;
                }
            }
            
            div.innerHTML = `
                <img src="${avatar}" alt="${participant.username}" class="participant-avatar">
                <div class="participant-info">
                    <div class="participant-name">${participant.nickname || participant.username}</div>
                    <div class="participant-stats">
                        승률: ${participant.stats.winRate}% | 평균킬: ${participant.stats.avgKills}
                    </div>
                </div>
                <div class="participant-tags">
                    ${countryInfo ? `<span title="${countryInfo.name}">${countryInfo.icon}</span>` : ''}
                    ${unitName ? `<span class="unit-tag">${unitName}</span>` : ''}
                </div>
                <div class="participant-actions">
                    ${actionsHtml}
                </div>
            `;
            
            return div;
        }

        // 국가 선택
        function selectCountry(country) {
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`[data-country="${country}"]`).classList.add('selected');
            selectedCountry = country;
        }

        // 참여 모달 열기
        function openJoinModal() {
            document.getElementById('join-modal').style.display = 'flex';
        }

        // 참여 모달 닫기
        function closeJoinModal() {
            document.getElementById('join-modal').style.display = 'none';
            selectedCountry = null;
        }

        // 파티 참여
        async function joinParty() {
            const country = selectedCountry;
            const unit = document.getElementById('unit-select').value;
            const position = document.getElementById('join-position').value;
            
            if (!country || !unit) {
                showToast('국가와 병종을 선택해주세요.', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'join',
                        to: position,
                        country,
                        unit
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '파티 참여 실패');
                }
                
                showToast('파티에 참여했습니다!', 'success');
                closeJoinModal();
                await loadPartyDetail();
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 참여자 이동
        async function moveParticipant(from, to) {
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'move',
                        from,
                        to
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '이동 실패');
                }
                
                showToast('위치를 이동했습니다!', 'success');
                await loadPartyDetail();
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 파티 탈퇴
        async function leaveParty() {
            if (!confirm('정말로 파티에서 탈퇴하시겠습니까?')) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'move',
                        from: myParticipation.team,
                        to: 'remove'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('탈퇴 실패');
                }
                
                showToast('파티에서 탈퇴했습니다.', 'success');
                await loadPartyDetail();
                
            } catch (error) {
                showToast('탈퇴 중 오류가 발생했습니다.', 'error');
            } finally {
                hideLoading();
            }
        }

        // 파티 종료 모달 열기
        function openCompleteModal() {
            document.getElementById('complete-modal').style.display = 'flex';
        }

        // 파티 종료 모달 닫기
        function closeCompleteModal() {
            document.getElementById('complete-modal').style.display = 'none';
        }

        // 파티 종료
        async function completeParty() {
            const outcome = document.getElementById('party-outcome').value;
            const resultMessage = document.getElementById('result-message').value;
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'complete',
                        outcome,
                        resultMessage
                    })
                });
                
                if (!response.ok) {
                    throw new Error('파티 종료 실패');
                }
                
                showToast('파티가 종료되었습니다!', 'success');
                closeCompleteModal();
                await loadPartyDetail();
                
            } catch (error) {
                showToast('파티 종료 중 오류가 발생했습니다.', 'error');
            } finally {
                hideLoading();
            }
        }

        // 파티 취소
        async function cancelParty() {
            if (!confirm('정말로 파티를 취소하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'cancel'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('파티 취소 실패');
                }
                
                showToast('파티가 취소되었습니다.', 'success');
                setTimeout(() => {
                    window.location.href = '/party';
                }, 1500);
                
            } catch (error) {
                showToast('파티 취소 중 오류가 발생했습니다.', 'error');
            } finally {
                hideLoading();
            }
        }

        // 파티 수정
        function editParty() {
            // TODO: 파티 수정 기능 구현
            showToast('파티 수정 기능은 준비 중입니다.', 'info');
        }

        // 전적 섹션 표시
        function displayStatsSection() {
            document.getElementById('stats-section').style.display = 'block';
            
            const statsForm = document.getElementById('stats-form');
            statsForm.innerHTML = '';
            
            // 모든 참여자 목록
            const allParticipants = [...currentParty.team1, ...currentParty.team2];
            
            allParticipants.forEach(participant => {
                const statsItem = document.createElement('div');
                statsItem.className = 'stats-player-item';
                
                const team = currentParty.team1.some(p => p.userId === participant.userId) ? 1 : 2;
                const existingStat = currentParty.playerStats?.find(s => s.userId === participant.userId);
                
                statsItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${participant.avatar ? `https://cdn.discordapp.com/avatars/${participant.userId}/${participant.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'}" style="width: 24px; height: 24px; border-radius: 50%;">
                        <span>${participant.nickname || participant.username}</span>
                    </div>
                    <div>
                        <select class="stats-input" data-user="${participant.userId}" data-field="team">
                            <option value="1" ${team === 1 ? 'selected' : ''}>1팀</option>
                            <option value="2" ${team === 2 ? 'selected' : ''}>2팀</option>
                        </select>
                    </div>
                    <input type="number" class="stats-input" data-user="${participant.userId}" data-field="kills" 
                           value="${existingStat?.kills || 0}" min="0" placeholder="킬">
                    <input type="number" class="stats-input" data-user="${participant.userId}" data-field="deaths" 
                           value="${existingStat?.deaths || 0}" min="0" placeholder="데스">
                    <div>
                        <select class="stats-input" data-user="${participant.userId}" data-field="won">
                            <option value="true" ${existingStat?.won ? 'selected' : ''}>승리</option>
                            <option value="false" ${!existingStat?.won ? 'selected' : ''}>패배</option>
                        </select>
                    </div>
                `;
                
                statsForm.appendChild(statsItem);
            });
        }

        // 전적 저장
        async function saveStats() {
            const statsInputs = document.querySelectorAll('.stats-input');
            const playerStats = {};
            
            statsInputs.forEach(input => {
                const userId = input.dataset.user;
                const field = input.dataset.field;
                
                if (!playerStats[userId]) {
                    playerStats[userId] = { userId };
                }
                
                if (field === 'team' || field === 'kills' || field === 'deaths') {
                    playerStats[userId][field] = parseInt(input.value);
                } else if (field === 'won') {
                    playerStats[userId][field] = input.value === 'true';
                }
            });
            
            const statsArray = Object.values(playerStats);
            
            showLoading();
            
            try {
                const response = await fetch(`/api/party/${currentParty.partyId}/stats`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ playerStats: statsArray })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '전적 저장 실패');
                }
                
                showToast('전적이 저장되었습니다!', 'success');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // 토스트 알림
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = toast.querySelector('.toast-icon');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toastIcon.className = 'toast-icon fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'toast-icon fas fa-exclamation-circle';
            } else {
                toastIcon.className = 'toast-icon fas fa-info-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>ord/emblem_[remade+upscaled].png" alt="제국">
                            <div class="country-name">제국</div>
                        </div>
                        <div class="country-btn" data-country="vlandia" onclick="selectCountry('vlandia')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/emblem_v_[upscaled].png" alt="블란디아">
                            <div class="country-name">블란디아</div>
                        </div>
                        <div class="country-btn" data-country="battania" onclick="selectCountry('battania')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerlord/emblem_[upscaled].png" alt="바타니아">
                            <div class="country-name">바타니아</div>
                        </div>
                        <div class="country-btn" data-country="sturgia" onclick="selectCountry('sturgia')">
                            <img src="https://mountandblade2bannerlord.wiki.fextralife.com/file/Mount-and-Blade-2-Bannerl