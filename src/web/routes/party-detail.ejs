<%- contentFor('head') %>
<link rel="stylesheet" href="/css/party-detail.css">

<%- contentFor('body') %>
<div class="content-wrapper">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <div class="header-actions">
            <a href="/party" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                íŒŒí‹° ëª©ë¡
            </a>
        </div>
        
        <div class="party-header-info">
            <div class="party-type-badge">
                <span class="party-emoji" id="partyEmoji">ğŸ®</span>
                <span class="party-type-name" id="partyTypeName">íŒŒí‹° íƒ€ì…</span>
            </div>
            <div class="party-status-badge" id="partyStatus">
                <span class="status-dot"></span>
                <span class="status-text">ìƒíƒœ</span>
            </div>
        </div>
        
        <h1 class="party-title" id="partyTitle">íŒŒí‹° ì œëª©</h1>
        <p class="party-description" id="partyDescription">íŒŒí‹° ì„¤ëª…</p>
    </div>

    <!-- íŒŒí‹° ì •ë³´ ì„¹ì…˜ -->
    <div class="party-info-section">
        <div class="info-grid">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="info-card">
                <h3 class="info-title">
                    <i class="fas fa-info-circle"></i>
                    ê¸°ë³¸ ì •ë³´
                </h3>
                <div class="info-content">
                    <div class="info-item">
                        <span class="info-label">ì£¼ìµœì</span>
                        <span class="info-value" id="hostName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">íŒŒí‹° ID</span>
                        <span class="info-value" id="partyId">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ìƒì„±ì¼</span>
                        <span class="info-value" id="createdAt">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ì¼ì • ì •ë³´ -->
            <div class="info-card">
                <h3 class="info-title">
                    <i class="fas fa-calendar-alt"></i>
                    ì¼ì • ì •ë³´
                </h3>
                <div class="info-content">
                    <div class="info-item">
                        <span class="info-label">ë‚ ì§œ</span>
                        <span class="info-value" id="scheduledDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì‹œê°„</span>
                        <span class="info-value" id="scheduledTime">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë‚¨ì€ ì‹œê°„</span>
                        <span class="info-value" id="timeRemaining">-</span>
                    </div>
                </div>
            </div>
            
            <!-- íŒ€ êµ¬ì„± ì •ë³´ -->
            <div class="info-card">
                <h3 class="info-title">
                    <i class="fas fa-users"></i>
                    íŒ€ êµ¬ì„±
                </h3>
                <div class="info-content">
                    <div class="info-item">
                        <span class="info-label">íŒ€ í¬ê¸°</span>
                        <span class="info-value" id="teamSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì´ ì°¸ì—¬ì</span>
                        <span class="info-value" id="totalParticipants">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ëŒ€ê¸°ì</span>
                        <span class="info-value" id="waitlistCount">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒ€ êµ¬ì„± ì„¹ì…˜ -->
    <div class="teams-section">
        <h2 class="section-title">
            <i class="fas fa-users"></i>
            íŒ€ êµ¬ì„±
        </h2>
        
        <div class="teams-grid">
            <!-- 1íŒ€ -->
            <div class="team-card team-1">
                <div class="team-header">
                    <h3>ğŸ”µ 1íŒ€</h3>
                    <span class="team-count" id="team1Count">0/0</span>
                </div>
                <div class="team-members" id="team1Members">
                    <!-- íŒ€ì›ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="team-actions" id="team1Actions">
                    <!-- ì°¸ì—¬ ë²„íŠ¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- 2íŒ€ -->
            <div class="team-card team-2">
                <div class="team-header">
                    <h3>ğŸ”´ 2íŒ€</h3>
                    <span class="team-count" id="team2Count">0/0</span>
                </div>
                <div class="team-members" id="team2Members">
                    <!-- íŒ€ì›ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="team-actions" id="team2Actions">
                    <!-- ì°¸ì—¬ ë²„íŠ¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
        
        <!-- ëŒ€ê¸°ì ëª©ë¡ -->
        <div class="waitlist-section" id="waitlistSection" style="display: none;">
            <div class="team-card waitlist">
                <div class="team-header">
                    <h3>â³ ëŒ€ê¸°ì</h3>
                    <span class="team-count" id="waitlistCountDisplay">0</span>
                </div>
                <div class="team-members" id="waitlistMembers">
                    <!-- ëŒ€ê¸°ìë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ì¤€ë¹„ë¬¼ ì„¹ì…˜ -->
    <div class="preparations-section" id="preparationsSection" style="display: none;">
        <h2 class="section-title">
            <i class="fas fa-list-check"></i>
            ì¤€ë¹„ë¬¼
        </h2>
        <div class="preparations-card">
            <div class="preparations-content" id="preparationsContent">
                <!-- ì¤€ë¹„ë¬¼ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- íŒŒí‹° ê´€ë¦¬ ì„¹ì…˜ (ì£¼ìµœì/ê´€ë¦¬ìë§Œ) -->
    <div class="party-management-section" id="partyManagementSection" style="display: none;">
        <h2 class="section-title">
            <i class="fas fa-cog"></i>
            íŒŒí‹° ê´€ë¦¬
        </h2>
        <div class="management-actions">
            <button class="btn btn-warning" id="editPartyBtn">
                <i class="fas fa-edit"></i>
                íŒŒí‹° ìˆ˜ì •
            </button>
            <button class="btn btn-success" id="startPartyBtn">
                <i class="fas fa-play"></i>
                íŒŒí‹° ì‹œì‘
            </button>
            <button class="btn btn-primary" id="completePartyBtn">
                <i class="fas fa-flag-checkered"></i>
                íŒŒí‹° ì™„ë£Œ
            </button>
            <button class="btn btn-danger" id="cancelPartyBtn">
                <i class="fas fa-times"></i>
                íŒŒí‹° ì·¨ì†Œ
            </button>
        </div>
    </div>

    <!-- íŒŒí‹° ê²°ê³¼ ì„¹ì…˜ (ì™„ë£Œëœ íŒŒí‹°ë§Œ) -->
    <div class="party-result-section" id="partyResultSection" style="display: none;">
        <h2 class="section-title">
            <i class="fas fa-trophy"></i>
            íŒŒí‹° ê²°ê³¼
        </h2>
        <div class="result-card" id="resultCard">
            <!-- ê²°ê³¼ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<%- include('../partials/modals') %>

<!-- íŒŒí‹° ì™„ë£Œ ëª¨ë‹¬ -->
<div class="modal" id="completePartyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">íŒŒí‹° ì™„ë£Œ</h3>
            <button class="modal-close" onclick="closeModal('completePartyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="completePartyForm">
                <div class="form-group">
                    <label class="form-label">ìŠ¹ë¦¬ íŒ€</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="winner" value="team1" required>
                            <span>1íŒ€ ìŠ¹ë¦¬</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="winner" value="team2" required>
                            <span>2íŒ€ ìŠ¹ë¦¬</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="winner" value="draw" required>
                            <span>ë¬´ìŠ¹ë¶€</span>
                        </label>
                    </div>
                </div>
                
                <div class="score-section">
                    <div class="form-group">
                        <label for="team1Score" class="form-label">1íŒ€ ì ìˆ˜</label>
                        <input type="number" id="team1Score" name="team1Score" class="form-input" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="team2Score" class="form-label">2íŒ€ ì ìˆ˜</label>
                        <input type="number" id="team2Score" name="team2Score" class="form-input" min="0" value="0">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('completePartyModal')">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì™„ë£Œ ì²˜ë¦¬</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
window.partyDetailData = {
    party: null,
    currentUser: null,
    isHost: false,
    isAdmin: false,
    userParticipation: null
};

// ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°
window.partyDetailData.party = <%- JSON.stringify(party) %>;
window.partyDetailData.currentUser = <%- JSON.stringify(user) %>;

// í˜ì´ì§€ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializePartyDetail();
});

// íŒŒí‹° ìƒì„¸ í˜ì´ì§€ ì´ˆê¸°í™”
function initializePartyDetail() {
    const party = window.partyDetailData.party;
    const user = window.partyDetailData.currentUser;
    
    if (!party || !user) {
        window.toast.error('íŒŒí‹° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê¶Œí•œ í™•ì¸
    window.partyDetailData.isHost = party.hostId === user.id;
    window.partyDetailData.isAdmin = ['admin', 'subadmin'].includes(user.dashboardRole);
    
    // ì‚¬ìš©ì ì°¸ì—¬ ìƒíƒœ í™•ì¸
    checkUserParticipation();
    
    // UI ë Œë”ë§
    renderPartyInfo();
    renderTeams();
    renderPreparations();
    renderManagementSection();
    renderResult();
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    setupEventListeners();
    
    // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
    setInterval(refreshPartyData, 30000);
    
    // ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
    setInterval(updateTimeRemaining, 1000);
}

// ì‚¬ìš©ì ì°¸ì—¬ ìƒíƒœ í™•ì¸
function checkUserParticipation() {
    const party = window.partyDetailData.party;
    const userId = window.partyDetailData.currentUser.id;
    
    // 1íŒ€ í™•ì¸
    const team1Member = party.team1.find(member => member.userId === userId);
    if (team1Member) {
        window.partyDetailData.userParticipation = { team: 1, member: team1Member };
        return;
    }
    
    // 2íŒ€ í™•ì¸
    const team2Member = party.team2.find(member => member.userId === userId);
    if (team2Member) {
        window.partyDetailData.userParticipation = { team: 2, member: team2Member };
        return;
    }
    
    // ëŒ€ê¸°ì í™•ì¸
    const waitlistMember = party.waitlist.find(member => member.userId === userId);
    if (waitlistMember) {
        window.partyDetailData.userParticipation = { team: 'waitlist', member: waitlistMember };
        return;
    }
    
    window.partyDetailData.userParticipation = null;
}

// íŒŒí‹° ì •ë³´ ë Œë”ë§
function renderPartyInfo() {
    const party = window.partyDetailData.party;
    
    const typeEmojis = {
        'ì •ê·œì „': 'âš”ï¸',
        'ëª¨ì˜ì „': 'ğŸ›¡ï¸',
        'í›ˆë ¨': 'ğŸ¯',
        'PVP': 'ğŸ†',
        'ê²€ì€ë°œí†±': 'ğŸ¦…',
        'ë ˆì´ë“œ': 'ğŸœï¸'
    };
    
    const statusTexts = {
        'recruiting': 'ëª¨ì§‘ ì¤‘',
        'in_progress': 'ì§„í–‰ ì¤‘',
        'completed': 'ì™„ë£Œë¨',
        'cancelled': 'ì·¨ì†Œë¨'
    };
    
    const statusColors = {
        'recruiting': 'success',
        'in_progress': 'warning',
        'completed': 'secondary',
        'cancelled': 'danger'
    };
    
    // í—¤ë” ì •ë³´
    document.getElementById('partyEmoji').textContent = typeEmojis[party.type] || 'ğŸ®';
    document.getElementById('partyTypeName').textContent = party.type;
    document.getElementById('partyTitle').textContent = party.title;
    document.getElementById('partyDescription').textContent = party.description || '';
    
    // ìƒíƒœ ë°°ì§€
    const statusElement = document.getElementById('partyStatus');
    statusElement.className = `party-status-badge status-${statusColors[party.status]}`;
    statusElement.querySelector('.status-text').textContent = statusTexts[party.status];
    
    // ê¸°ë³¸ ì •ë³´
    document.getElementById('hostName').textContent = party.hostName;
    document.getElementById('partyId').textContent = party.partyId;
    document.getElementById('createdAt').textContent = new Date(party.createdAt).toLocaleDateString('ko-KR');
    
    // ì¼ì • ì •ë³´
    const scheduledDate = new Date(party.scheduledDate);
    document.getElementById('scheduledDate').textContent = scheduledDate.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    document.getElementById('scheduledTime').textContent = party.scheduledTime;
    
    // íŒ€ êµ¬ì„± ì •ë³´
    document.getElementById('teamSize').textContent = `${party.maxTeamSize}v${party.maxTeamSize}`;
    document.getElementById('totalParticipants').textContent = party.team1.length + party.team2.length;
    document.getElementById('waitlistCount').textContent = party.waitlist.length;
    
    updateTimeRemaining();
}

// ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
function updateTimeRemaining() {
    const party = window.partyDetailData.party;
    const scheduledDateTime = new Date(`${party.scheduledDate}T${party.scheduledTime}`);
    const now = new Date();
    const timeDiff = scheduledDateTime - now;
    
    let timeText = '';
    if (timeDiff > 0) {
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
            timeText = `${days}ì¼ ${hours}ì‹œê°„ í›„`;
        } else if (hours > 0) {
            timeText = `${hours}ì‹œê°„ ${minutes}ë¶„ í›„`;
        } else {
            timeText = `${minutes}ë¶„ í›„`;
        }
    } else {
        timeText = 'ì‹œê°„ ì§€ë‚¨';
    }
    
    document.getElementById('timeRemaining').textContent = timeText;
}

// íŒ€ ë Œë”ë§
function renderTeams() {
    const party = window.partyDetailData.party;
    
    // 1íŒ€
    renderTeam(1, party.team1, party.maxTeamSize);
    
    // 2íŒ€
    renderTeam(2, party.team2, party.maxTeamSize);
    
    // ëŒ€ê¸°ì
    renderWaitlist(party.waitlist);
}

// ê°œë³„ íŒ€ ë Œë”ë§
function renderTeam(teamNumber, members, maxSize) {
    const teamMembersEl = document.getElementById(`team${teamNumber}Members`);
    const teamCountEl = document.getElementById(`team${teamNumber}Count`);
    const teamActionsEl = document.getElementById(`team${teamNumber}Actions`);
    
    // íŒ€ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
    teamCountEl.textContent = `${members.length}/${maxSize}`;
    
    // íŒ€ì› ëª©ë¡ ë Œë”ë§
    if (members.length === 0) {
        teamMembersEl.innerHTML = '<div class="empty-team">íŒ€ì›ì„ ëª¨ì§‘ ì¤‘ì…ë‹ˆë‹¤</div>';
    } else {
        teamMembersEl.innerHTML = members.map(member => `
            <div class="member-item">
                <div class="member-avatar">
                    <img src="${member.avatar || '/images/default-avatar.png'}" alt="${member.username}">
                </div>
                <div class="member-info">
                    <div class="member-name">${escapeHtml(member.username)}</div>
                    <div class="member-joined">
                        ${new Date(member.joinedAt).toLocaleDateString('ko-KR')}
                    </div>
                </div>
                ${window.partyDetailData.isHost || window.partyDetailData.isAdmin ? `
                    <button class="btn-remove" onclick="removeMember('${member.userId}', ${teamNumber})" title="íŒ€ì—ì„œ ì œê±°">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
            </div>
        `).join('');
    }
    
    // íŒ€ ì°¸ì—¬ ë²„íŠ¼ ë Œë”ë§
    renderTeamActions(teamNumber, members, maxSize);
}

// íŒ€ ì•¡ì…˜ ë²„íŠ¼ ë Œë”ë§
function renderTeamActions(teamNumber, members, maxSize) {
    const party = window.partyDetailData.party;
    const teamActionsEl = document.getElementById(`team${teamNumber}Actions`);
    const userParticipation = window.partyDetailData.userParticipation;
    
    if (party.status !== 'recruiting') {
        teamActionsEl.innerHTML = '';
        return;
    }
    
    let actionHTML = '';
    
    if (!userParticipation) {
        // ì°¸ì—¬í•˜ì§€ ì•Šì€ ê²½ìš°
        if (members.length < maxSize) {
            actionHTML = `
                <button class="btn btn-primary btn-join" onclick="joinTeam(${teamNumber})">
                    <i class="fas fa-plus"></i>
                    ${teamNumber}íŒ€ ì°¸ì—¬
                </button>
            `;
        } else {
            actionHTML = `
                <button class="btn btn-secondary btn-waitlist" onclick="joinWaitlist()">
                    <i class="fas fa-clock"></i>
                    ëŒ€ê¸°ì—´ ì°¸ì—¬
                </button>
            `;
        }
    } else if (userParticipation.team === teamNumber) {
        // í˜„ì¬ íŒ€ì— ì°¸ì—¬ ì¤‘ì¸ ê²½ìš°
        actionHTML = `
            <button class="btn btn-danger btn-leave" onclick="leaveTeam()">
                <i class="fas fa-minus"></i>
                íŒ€ íƒˆí‡´
            </button>
        `;
    } else if (userParticipation.team !== 'waitlist') {
        // ë‹¤ë¥¸ íŒ€ì— ì°¸ì—¬ ì¤‘ì¸ ê²½ìš°
        if (members.length < maxSize) {
            actionHTML = `
                <button class="btn btn-outline btn-switch" onclick="switchTeam(${teamNumber})">
                    <i class="fas fa-exchange-alt"></i>
                    ${teamNumber}íŒ€ìœ¼ë¡œ ì´ë™
                </button>
            `;
        }
    }
    
    teamActionsEl.innerHTML = actionHTML;
}

// ëŒ€ê¸°ì ë Œë”ë§
function renderWaitlist(waitlist) {
    const waitlistSection = document.getElementById('waitlistSection');
    const waitlistMembers = document.getElementById('waitlistMembers');
    const waitlistCount = document.getElementById('waitlistCountDisplay');
    
    if (waitlist.length === 0) {
        waitlistSection.style.display = 'none';
        return;
    }
    
    waitlistSection.style.display = 'block';
    waitlistCount.textContent = waitlist.length;
    
    waitlistMembers.innerHTML = waitlist.map((member, index) => `
        <div class="member-item waitlist-member">
            <div class="waitlist-position">${index + 1}</div>
            <div class="member-avatar">
                <img src="${member.avatar || '/images/default-avatar.png'}" alt="${member.username}">
            </div>
            <div class="member-info">
                <div class="member-name">${escapeHtml(member.username)}</div>
                <div class="member-joined">
                    ${new Date(member.joinedAt).toLocaleDateString('ko-KR')}
                </div>
            </div>
            ${window.partyDetailData.isHost || window.partyDetailData.isAdmin ? `
                <button class="btn-remove" onclick="removeMember('${member.userId}', 'waitlist')" title="ëŒ€ê¸°ì—´ì—ì„œ ì œê±°">
                    <i class="fas fa-times"></i>
                </button>
            ` : ''}
        </div>
    `).join('');
}

// ì¤€ë¹„ë¬¼ ë Œë”ë§
function renderPreparations() {
    const party = window.partyDetailData.party;
    const preparationsSection = document.getElementById('preparationsSection');
    const preparationsContent = document.getElementById('preparationsContent');
    
    if (!party.preparations) {
        preparationsSection.style.display = 'none';
        return;
    }
    
    preparationsSection.style.display = 'block';
    preparationsContent.innerHTML = `<p>${escapeHtml(party.preparations).replace(/\n/g, '<br>')}</p>`;
}

// ê´€ë¦¬ ì„¹ì…˜ ë Œë”ë§
function renderManagementSection() {
    const party = window.partyDetailData.party;
    const managementSection = document.getElementById('partyManagementSection');
    
    if (!window.partyDetailData.isHost && !window.partyDetailData.isAdmin) {
        managementSection.style.display = 'none';
        return;
    }
    
    managementSection.style.display = 'block';
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const editBtn = document.getElementById('editPartyBtn');
    const startBtn = document.getElementById('startPartyBtn');
    const completeBtn = document.getElementById('completePartyBtn');
    const cancelBtn = document.getElementById('cancelPartyBtn');
    
    // íŒŒí‹° ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    switch (party.status) {
        case 'recruiting':
            editBtn.disabled = false;
            startBtn.disabled = false;
            completeBtn.disabled = true;
            cancelBtn.disabled = false;
            break;
        case 'in_progress':
            editBtn.disabled = true;
            startBtn.disabled = true;
            completeBtn.disabled = false;
            cancelBtn.disabled = false;
            break;
        case 'completed':
        case 'cancelled':
            editBtn.disabled = true;
            startBtn.disabled = true;
            completeBtn.disabled = true;
            cancelBtn.disabled = true;
            break;
    }
}

// ê²°ê³¼ ë Œë”ë§
function renderResult() {
    const party = window.partyDetailData.party;
    const resultSection = document.getElementById('partyResultSection');
    const resultCard = document.getElementById('resultCard');
    
    if (party.status !== 'completed' || !party.result) {
        resultSection.style.display = 'none';
        return;
    }
    
    resultSection.style.display = 'block';
    
    const result = party.result;
    const winnerText = result.winner === 'team1' ? '1íŒ€ ìŠ¹ë¦¬' : 
                     result.winner === 'team2' ? '2íŒ€ ìŠ¹ë¦¬' : 'ë¬´ìŠ¹ë¶€';
    
    resultCard.innerHTML = `
        <div class="result-header">
            <h3>${winnerText}</h3>
            ${result.team1Score !== undefined && result.team2Score !== undefined ? 
                `<div class="score">
                    <span class="team1-score">${result.team1Score}</span>
                    <span class="vs">:</span>
                    <span class="team2-score">${result.team2Score}</span>
                </div>` : ''
            }
        </div>
        <div class="result-info">
            <p><strong>ì™„ë£Œ ì²˜ë¦¬ì:</strong> ${escapeHtml(result.completedBy)}</p>
            <p><strong>ì™„ë£Œ ì‹œê°„:</strong> ${new Date(result.completedAt).toLocaleString('ko-KR')}</p>
        </div>
    `;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // íŒŒí‹° ê´€ë¦¬ ë²„íŠ¼ë“¤
    document.getElementById('editPartyBtn').addEventListener('click', editParty);
    document.getElementById('startPartyBtn').addEventListener('click', startParty);
    document.getElementById('completePartyBtn').addEventListener('click', () => openModal('completePartyModal'));
    document.getElementById('cancelPartyBtn').addEventListener('click', cancelParty);
    
    // íŒŒí‹° ì™„ë£Œ í¼
    document.getElementById('completePartyForm').addEventListener('submit', completeParty);
}

// íŒ€ ì°¸ì—¬
async function joinTeam(teamNumber) {
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: teamNumber })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success(`${teamNumber}íŒ€ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!`);
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒ€ ì°¸ì—¬ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// ëŒ€ê¸°ì—´ ì°¸ì—¬
async function joinWaitlist() {
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: 'waitlist' })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('ëŒ€ê¸°ì—´ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('ëŒ€ê¸°ì—´ ì°¸ì—¬ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒ€ íƒˆí‡´
async function leaveTeam() {
    if (!confirm('ì •ë§ë¡œ íŒ€ì—ì„œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/leave`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('íŒ€ì—ì„œ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒ€ íƒˆí‡´ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒ€ ë³€ê²½
async function switchTeam(teamNumber) {
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: teamNumber })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success(`${teamNumber}íŒ€ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤!`);
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒ€ ë³€ê²½ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// ë©¤ë²„ ì œê±° (ì£¼ìµœì/ê´€ë¦¬ìë§Œ)
async function removeMember(userId, team) {
    if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, team })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('ì‚¬ìš©ìê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('ë©¤ë²„ ì œê±° ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒŒí‹° ìˆ˜ì •
function editParty() {
    window.toast.info('íŒŒí‹° ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

// íŒŒí‹° ì‹œì‘
async function startParty() {
    if (!confirm('íŒŒí‹°ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‹œì‘ í›„ì—ëŠ” ìƒˆë¡œìš´ ì°¸ì—¬ìê°€ ë“¤ì–´ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/start`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('íŒŒí‹°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒŒí‹° ì‹œì‘ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒŒí‹° ì™„ë£Œ
async function completeParty(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        action: 'complete',
        winner: formData.get('winner'),
        team1Score: parseInt(formData.get('team1Score')) || 0,
        team2Score: parseInt(formData.get('team2Score')) || 0
    };
    
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/end`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('íŒŒí‹°ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal('completePartyModal');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒŒí‹° ì™„ë£Œ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒŒí‹° ì·¨ì†Œ
async function cancelParty() {
    if (!confirm('ì •ë§ë¡œ íŒŒí‹°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}/end`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'cancel' })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            window.toast.success('íŒŒí‹°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await refreshPartyData();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('íŒŒí‹° ì·¨ì†Œ ì˜¤ë¥˜:', error);
        window.toast.error(error.message);
    }
}

// íŒŒí‹° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
async function refreshPartyData() {
    try {
        const response = await fetch(`/party/api/${window.partyDetailData.party.partyId}`);
        if (!response.ok) throw new Error('íŒŒí‹° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        
        const updatedParty = await response.json();
        window.partyDetailData.party = updatedParty;
        
        // ì‚¬ìš©ì ì°¸ì—¬ ìƒíƒœ ì¬í™•ì¸
        checkUserParticipation();
        
        // UI ë‹¤ì‹œ ë Œë”ë§
        renderPartyInfo();
        renderTeams();
        renderManagementSection();
        renderResult();
        
    } catch (error) {
        console.error('íŒŒí‹° ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
    }
}

// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        const modalId = event.target.id;
        closeModal(modalId);
    }
});
</script>

<style>
/* íŒŒí‹° ìƒì„¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
.content-wrapper {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
}

/* í˜ì´ì§€ í—¤ë” */
.page-header {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 32px;
    text-align: center;
    position: relative;
}

.header-actions {
    position: absolute;
    top: 20px;
    left: 20px;
}

.party-header-info {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 24px;
}

.party-type-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--accent-primary);
    color: white;
    border-radius: 20px;
    font-weight: 500;
}

.party-emoji {
    font-size: 20px;
}

.party-status-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
}

.party-status-badge .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-success {
    background: rgba(59, 165, 92, 0.2);
    color: var(--success);
}

.status-success .status-dot {
    background: var(--success);
}

.status-warning {
    background: rgba(250, 166, 26, 0.2);
    color: var(--warning);
}

.status-warning .status-dot {
    background: var(--warning);
}

.status-secondary {
    background: rgba(116, 127, 141, 0.2);
    color: var(--text-secondary);
}

.status-secondary .status-dot {
    background: var(--text-secondary);
}

.status-danger {
    background: rgba(237, 66, 69, 0.2);
    color: var(--danger);
}

.status-danger .status-dot {
    background: var(--danger);
}

.party-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-primary);
}

.party-description {
    font-size: 1.1rem;
    color: var(--text-secondary);
    line-height: 1.6;
    max-width: 800px;
    margin: 0 auto;
}

/* ì •ë³´ ì„¹ì…˜ */
.party-info-section {
    margin-bottom: 32px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.info-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
}

.info-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 16px;
}

.info-title i {
    color: var(--accent-primary);
}

.info-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-size: 14px;
    color: var(--text-secondary);
}

.info-value {
    font-weight: 500;
    color: var(--text-primary);
}

/* ì„¹ì…˜ íƒ€ì´í‹€ */
.section-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 24px;
}

.section-title i {
    color: var(--accent-primary);
}

/* íŒ€ ì„¹ì…˜ */
.teams-section {
    margin-bottom: 32px;
}

.teams-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.team-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.team-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
}

.team-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text-primary);
}

.team-count {
    font-weight: 600;
    color: var(--accent-primary);
}

.team-members {
    padding: 16px;
    min-height: 200px;
}

.empty-team {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 160px;
    color: var(--text-muted);
    text-align: center;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    margin-bottom: 8px;
    position: relative;
}

.member-item:last-child {
    margin-bottom: 0;
}

.waitlist-position {
    width: 24px;
    height: 24px;
    background: var(--accent-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border-color);
}

.member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.member-info {
    flex: 1;
}

.member-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.member-joined {
    font-size: 12px;
    color: var(--text-muted);
}

.btn-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border: none;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s;
}

.member-item:hover .btn-remove {
    opacity: 1;
}

.team-actions {
    padding: 16px;
    border-top: 1px solid var(--border-color);
}

.team-actions .btn {
    width: 100%;
}

/* ëŒ€ê¸°ì ì„¹ì…˜ */
.waitlist-section {
    margin-top: 24px;
}

.waitlist .team-header {
    background: rgba(250, 166, 26, 0.1);
}

/* ì¤€ë¹„ë¬¼ ì„¹ì…˜ */
.preparations-section {
    margin-bottom: 32px;
}

.preparations-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
}

.preparations-content p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
}

/* ê´€ë¦¬ ì„¹ì…˜ */
.party-management-section {
    margin-bottom: 32px;
}

.management-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.management-actions .btn {
    flex: 1;
    min-width: 140px;
}

/* ê²°ê³¼ ì„¹ì…˜ */
.party-result-section {
    margin-bottom: 32px;
}

.result-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.result-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
}

.score {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.5rem;
    font-weight: 700;
}

.team1-score {
    color: #5865F2;
}

.team2-score {
    color: #ED4245;
}

.vs {
    color: var(--text-muted);
}

.result-info {
    color: var(--text-secondary);
    line-height: 1.6;
}

.result-info p {
    margin: 8px 0;
}

/* ëª¨ë‹¬ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
    background-color: var(--bg-primary);
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    width: 90%;
    max-width: 500px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: var(--text-primary);
}

.score-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .party-header-info {
        flex-direction: column;
        gap: 12px;
    }
    
    .header-actions {
        position: static;
        margin-bottom: 16px;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .teams-grid {
        grid-template-columns: 1fr;
    }
    
    .management-actions {
        flex-direction: column;
    }
    
    .result-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .modal-actions {
        flex-direction: column;
    }
    
    .score-section {
        grid-template-columns: 1fr;
    }
}
</style>